name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  validate-scripts:
    runs-on: ubuntu-latest
    steps:
      # Checkout full history to ensure git diff works
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Node.js setup
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      # Install dependencies
      - name: Install dependencies
        run: npm ci

      # Detect if scripts changed
      - name: Determine if scripts changed
        id: check_changes
        shell: bash
        run: |
          # Find merge base with main (safe for force pushes)
          BASE=$(git merge-base HEAD origin/main)
          echo "Merge base: $BASE"

          # List added/renamed scripts
          matches=$(git diff --name-status "$BASE" HEAD | grep -E '^[AR]\s+(scripts/|docs/scripts/).+\.js$' || true)

          if [ -n "$matches" ]; then
            echo "Changed scripts:"
            echo "$matches"
            echo "scripts_changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "No added or renamed scripts detected"
            echo "scripts_changed=false" >> "$GITHUB_OUTPUT"
          fi

      # Run script validation if scripts changed
      - name: Run script validation
        id: validate
        if: steps.check_changes.outputs.scripts_changed == 'true'
        shell: bash
        run: |
          set -o pipefail
          npm run validate-scripts 2>&1 | tee validation.log
          echo "validation_exit_code=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT

      # Comment on PR if validation fails
      - name: Comment on PR if validation fails
        if: steps.validate.outputs.validation_exit_code != '0' && github.event_name == 'pull_request'
        uses: ./.github/workflows/commenter.yml
        with:
          issue_number: ${{ github.event.pull_request.number }}
          message: |
            ⚠️ **Script validation failed!**
            The following issues were found with your PR (latest 100 lines):
            ```
            $(tail -n 100 validation.log)
            ```
          is_pr: true
