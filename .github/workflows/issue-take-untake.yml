name: Issue Take/Untake Workflow

on:
  issues:
    types: [opened]
  issue_comment:
    types: [created]
  schedule:
    - cron: '0 0 * * 0' # weekly cleanup (UTC)

permissions:
  contents: read
  issues: write

jobs:
  take_untake:
    if: >
      github.event_name == 'issues' ||
      (github.event_name == 'issue_comment' &&
      github.actor != 'github-actions[bot]')

    runs-on: ubuntu-latest
    steps:
      - name: Handle issue take/untake and body status
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const BOT_LOGIN = 'github-actions[bot]';
            const takenLabel = 'taken';
            const MARKER_PREFIX = '<!-- take-meta:';
            const BODY_START = '<!-- issue-take-untake:start -->';
            const BODY_END = '<!-- issue-take-untake:end -->';
            const EXPIRE_MS = 21 * 24 * 60 * 60 * 1000; // Claims expire after 21 days

            const isIssueOpen = context.eventName === 'issues';
            const isComment = context.eventName === 'issue_comment';

            const issueNumber = context.payload.issue.number;

            function buildUntakenBody() {
              return `
            ${BODY_START}
            > [!TIP]
            > This issue hasn't been claimed yet. Comment \`/take\` if you'd like to work on it!
            >
            > > For more information on how Img2Num's claim system works, please see #99.
            >
            > <sub>This edit was made by the [\`issue-take-untake\`](https://github.com/Ryan-Millard/Img2Num/blob/main/.github/workflows/issue-take-untake.yml) GitHub workflow</sub>
            ${BODY_END}
            `.trim();
            }

            function buildTakenBody(ownerName) {
              return `
            ${BODY_START}
            > [!CAUTION]
            > This issue has been claimed, so it is not recommended that you work on it.
            >
            > > For more information on how Img2Num's claim system works, please see #99.
            >
            > > **For the owner of the claim:**
            > > If you would like to revoke your claim, comment \`/untake\`
            >
            > <sub>This edit was made by the [\`issue-take-untake\`](https://github.com/Ryan-Millard/Img2Num/blob/main/.github/workflows/issue-take-untake.yml) GitHub workflow</sub>
            ${BODY_END}
            `.trim();
            }

            async function updateIssueBody(newBanner) {
              const issue = await github.rest.issues.get({ owner, repo, issue_number: issueNumber });
              const body = issue.data.body || '';

              let updated;
              if (body.includes(BODY_START)) {
                updated = body.replace(
                  new RegExp(`${BODY_START}[\\s\\S]*?${BODY_END}`),
                  newBanner
                );
              } else {
                updated = `${newBanner}\n\n---\n\n${body}`;
              }

              await github.rest.issues.update({
                owner,
                repo,
                issue_number: issueNumber,
                body: updated
              });
            }

            if (isIssueOpen) {
              try {
                await github.rest.issues.createLabel({
                  owner,
                  repo,
                  name: takenLabel,
                  color: 'ff0000',
                  description: 'Issue is currently claimed'
                });
              } catch (e) {}

              await updateIssueBody(buildUntakenBody());
              return;
            }

            if (!isComment) return;

            const comment = context.payload.comment;
            const commenter = comment.user.login;
            const bodyText = (comment.body || '').trim();

            const isTake = /^\/take(\s|$)/i.test(bodyText);
            const isUntake = /^\/untake(\s|$)/i.test(bodyText);
            if (!isTake && !isUntake) return;

            const issueResp = await github.rest.issues.get({ owner, repo, issue_number: issueNumber });
            const labels = (issueResp.data.labels || []).map(l => typeof l === 'string' ? l : l.name);
            const hasTakenLabel = labels.includes(takenLabel);

            const commentsResp = await github.rest.issues.listComments({ owner, repo, issue_number: issueNumber, per_page: 200 });
            const comments = commentsResp.data || [];

            let meta = { owner: null, members: [], ts: 0 };
            const latestMeta = comments
            .filter(c => c.user?.login === BOT_LOGIN && c.body?.includes(MARKER_PREFIX))
            .sort((a, b) => new Date(a.created_at) - new Date(b.created_at))
            .pop();

            if (latestMeta) {
              try {
                const json = latestMeta.body.split(MARKER_PREFIX)[1].split('-->')[0].trim();
                meta = JSON.parse(json);
              } catch {}
            }

            const now = Date.now();

            async function persistMeta(metaObj, claimed) {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: issueNumber,
                body: `${MARKER_PREFIX}${JSON.stringify(metaObj)} -->`
              });

              if (claimed) {
                await github.rest.issues.addLabels({ owner, repo, issue_number: issueNumber, labels: [takenLabel] });
                await updateIssueBody(buildTakenBody(metaObj.owner));
              } else {
                try {
                  await github.rest.issues.removeLabel({ owner, repo, issue_number: issueNumber, name: takenLabel });
                } catch {}
                await updateIssueBody(buildUntakenBody());
              }
            }


            if (isTake && !meta.owner) {
              meta.owner = commenter;
              meta.ts = now;
              await persistMeta(meta, true);
              return;
            }

            if (isUntake && meta.owner === commenter) {
              meta = { owner: null, members: [], ts: 0 };
              await persistMeta(meta, false);
              return;
            }

  cleanup:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    steps:
      - name: Expire stale claims
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const takenLabel = 'taken';
            const MARKER_PREFIX = '<!-- take-meta:';
            const BODY_START = '<!-- issue-take-untake:start -->';
            const BODY_END = '<!-- issue-take-untake:end -->';
            const EXPIRE_MS = 21 * 24 * 60 * 60 * 1000;

            function buildUntakenBody() {
              return `
            ${BODY_START}
            > [!TIP]
            > This issue hasn't been claimed yet. Comment \`/take\` if you'd like to work on it!
            >
            > > For more information on how Img2Num's claim system works, please see #99.
            >
            > <sub>This edit was made by the [\`issue-take-untake\`](https://github.com/Ryan-Millard/Img2Num/blob/main/.github/workflows/issue-take-untake.yml) GitHub workflow</sub>
            ${BODY_END}
            `.trim();
            }

            const issues = await github.rest.issues.listForRepo({
              owner,
              repo,
              labels: takenLabel,
              state: 'open',
              per_page: 100
            });

            for (const issue of issues.data) {
              const comments = await github.rest.issues.listComments({
                owner,
                repo,
                issue_number: issue.number,
                per_page: 200
              });

              const metaComment = comments.data
                .filter(c => c.body?.includes(MARKER_PREFIX))
                .pop();

              if (!metaComment) continue;

              try {
                const meta = JSON.parse(metaComment.body.split(MARKER_PREFIX)[1].split('-->')[0].trim());
                if (meta.ts && Date.now() - meta.ts > EXPIRE_MS) {
                  await github.rest.issues.removeLabel({ owner, repo, issue_number: issue.number, name: takenLabel });

                  const body = issue.body || '';
                  let updated;
                  if (body.includes(BODY_START)) {
                    updated = body.replace(
                      new RegExp(`${BODY_START}[\\s\\S]*?${BODY_END}`),
                      buildUntakenBody()
                    );
                  } else {
                    updated = `${buildUntakenBody()}\n\n---\n\n${body}`;
                  }

                  await github.rest.issues.update({
                    owner,
                    repo,
                    issue_number: issue.number,
                    body: updated
                  });
                }
              } catch {}
            }
