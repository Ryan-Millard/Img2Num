# ------------------------
# Img2Num Dockerfile.dev
# ------------------------
FROM node:22-bullseye

ENV EMSDK_VERSION=4.0.10
ENV EMSDK_DIR=/opt/emsdk

RUN apt-get update \
  && apt-get install -y --no-install-recommends \
    build-essential \
    cmake \
    python3 \
    git \
    curl \
    unzip \
    pkg-config \
    bash \
    ca-certificates \
    libvips-dev \
    # graphviz enables diagrams in doxygen
    doxygen graphviz \
  && rm -rf /var/lib/apt/lists/*

# Install EMSDK once, cached by Docker layers
RUN git clone --depth 1 https://github.com/emscripten-core/emsdk.git $EMSDK_DIR \
  && cd $EMSDK_DIR \
  && git fetch --tags \
  && git checkout $EMSDK_VERSION \
  && ./emsdk install $EMSDK_VERSION \
  && ./emsdk activate $EMSDK_VERSION
ENV PATH=$EMSDK_DIR:$EMSDK_DIR/upstream/emscripten:$PATH
ENV EMSDK=$EMSDK_DIR

# Download stb_image.h into a standard include directory
RUN mkdir -p /usr/include/stb \
  && curl -L https://raw.githubusercontent.com/nothings/stb/master/stb_image.h \
        -o /usr/include/stb/stb_image.h \
  && curl -L https://raw.githubusercontent.com/nothings/stb/master/stb_image_write.h \
        -o /usr/include/stb/stb_image_write.h

# Install pnpm
RUN corepack enable \
  && corepack prepare pnpm@10.29.1 --activate

# Corepack installs pnpm here for root
ENV PATH=/root/.local/share/pnpm:$PATH
ENV PNPM_STORE_DIR=/pnpm/store

WORKDIR /usr/src/app

ENV CHOKIDAR_USEPOLLING=true
ENV CHOKIDAR_INTERVAL=100

EXPOSE 5173 3000

CMD ["bash"]
