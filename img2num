#!/usr/bin/env bash
set -e
# Stop execution on errors
MODE="$1"
shift || true

ensure_container() {
  # Check if the dev service container is running, start it if not
  container_id=$(docker compose ps -q dev)
  if [ -z "$container_id" ]; then
    echo "Starting dev container..."
    docker compose up -d dev
  fi
}

# Run a command inside the dev container
run_in_container() {
  ensure_container
  if [ "$(docker ps -q -f name=img2num-dev)" ]; then
    docker compose exec dev "$@"
  else
    docker compose run --rm dev "$@"
  fi
}

# Main command dispatch
case "$MODE" in
  # Commands that map directly to npm scripts
  dev|dev:all|dev:debug|dev:all:debug|build|build-js|build-wasm|build-wasm:debug|preview|docs|lint|lint:fix|lint:style|format|format-js|format-wasm|clean|clean-js|clean-wasm|help)
    if [ "$MODE" = "docs" ]; then
      YELLOW=""
      MAGENTA=""
      RESET=""
      # Check if terminal supports colors
      if [ -t 1 ] && command -v tput >/dev/null 2>&1 && [ "$(tput colors)" -ge 8 ]; then
          YELLOW="$(tput setaf 3)"
          MAGENTA="$(tput setaf 5)"
          RESET="$(tput sgr0)"
      fi

      # Informative warning about Docusaurus port forwarding
      echo -e "${YELLOW}[INFO] Docusaurus is running inside the container, listening on all interfaces (0.0.0.0).${RESET}"
      echo -e "${YELLOW}[INFO] You cannot use the 0.0.0.0 link directly.${RESET}"
      echo -e "${YELLOW}[INFO] Access the site in your browser via: ${MAGENTA}http://localhost:3000/Img2Num/info/${RESET}"
    fi

    run_in_container npm run "$MODE" "$@"
    ;;

  # Arbitrary npm commands
  npm)
    run_in_container npm "$@"
    ;;

  # Open a shell in the container
  sh|shell|bash|term|terminal)
    run_in_container bash
    ;;

  # Docker management shortcuts
  stop) docker compose stop ;;
  restart) docker compose restart ;;
  down) docker compose down ;;
  destroy)
    docker compose down --volumes --remove-orphans
    [ "$MODE" = "destroy" ] && docker rmi img2num-dev:latest
    ;;

  # Tail logs
  logs) docker compose logs -f ;;

  # Fallback usage
  -h|--help|*)
    EXIT_CODE=0
    echo
    if [ "$MODE" != "-h" ] && [ "$MODE" != "--help" ]; then
      EXIT_CODE=1
      echo "Unknown command used."
      echo
    fi

    cat <<EOF
Usage:
  ./img2num <command>

Commands:
  NPM Scripts (use help see more info about each script):
    build|build-js|build-wasm|build-wasm:debug
    clean|clean-js|clean-wasm
    dev|dev:all|dev:debug|dev:all:debug
    docs
    format|format-js|format-wasm
    help
    lint|lint:fix|lint:style
    preview

  Using NPM Directly:
    npm <args>       Run arbitrary npm command

  Open Container Terminal:
    sh|shell|bash

  Docker Maintenance:
    stop
    restart
    down
    destroy
    logs
EOF
    exit $EXIT_CODE
    ;;
esac
